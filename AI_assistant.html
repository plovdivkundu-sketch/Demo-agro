<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="manifest" href="manifest.json" />

    <meta name="theme-color" content="#4CAF50" />

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="Agro Suvidha" />
    <link rel="apple-touch-icon" href="icons/icon-192x192.png" />
    <title>Kisan Mitra Chatbot</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f4f4f4;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }

      .chat-container {
        width: 400px;
        height: 600px;
        background: #fff;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      .chat-header {
        background: #16a34a;
        color: white;
        padding: 15px;
        text-align: center;
        font-size: 18px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        position: relative;
      }

      .back-btn {
        position: absolute;
        left: 10px;
        padding: 5px 10px;
        border: none;
        border-radius: 6px;
        background: #f3f3f3;
        cursor: pointer;
      }

      .chat-box {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }

      .message {
        max-width: 70%;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 10px;
        font-size: 14px;
        line-height: 1.4;
      }

      .user-message {
        background: #16a34a;
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 0;
      }

      .bot-message {
        background: #e5e5ea;
        color: black;
        align-self: flex-start;
        border-bottom-left-radius: 0;
      }

      .chat-input {
        display: flex;
        border-top: 1px solid #ddd;
        align-items: center;
        gap: 6px;
        padding: 6px;
      }

      .chat-input input {
        flex: 1;
        padding: 12px;
        border: none;
        outline: none;
        font-size: 14px;
        border-radius: 20px;
        background: #f7f7f7;
      }

      /* Common round button style */
      .round-btn {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        transition: 0.2s;
        border: none;
      }

      /* Mic button */
      .mic-btn {
        background: #16a34a;
      }

      .mic-btn:hover {
        background: #0d6e29;
      }

      .mic-btn.listening {
        background: #e53935;
        box-shadow: 0 0 10px rgba(229, 57, 53, 0.8);
      }

      .mic-btn svg {
        width: 18px;
        height: 18px;
        fill: white;
      }

      /* Send button */
      .send-btn {
        background: #16a34a;
      }

      .send-btn:hover {
        background: #0d6e29;
      }

      .send-btn svg {
        width: 18px;
        height: 18px;
        fill: white;
      }

      /* Language selector */
      .lang-select {
        margin: 8px;
        border-radius: 6px;
        padding: 5px;
        font-size: 14px;
      }
      .back-btn {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        padding: 6px 10px;
        border: none;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        font-size: 18px;
        cursor: pointer;
        transition: 0.3s;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }

      .back-btn:hover {
        background: rgba(255, 255, 255, 0.4);
        transform: translateY(-50%) scale(1.1);
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header">
        <button class="back-btn" id="back-btn">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            width="20"
            height="20"
            fill="white"
          >
            <path d="M15 18l-6-6 6-6" />
          </svg>
        </button>
        ‡§ï‡§ø‡§∏‡§æ‡§® ‡§Æ‡§ø‡§§‡•ç‡§∞ | Kisan Mitra
      </div>
      <select id="language" class="lang-select">
        <option value="en">English</option>
        <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
        <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)</option>
        <option value="pa">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä (Punjabi)</option>
      </select>
      <div class="chat-box" id="chat-box"></div>
      <div class="chat-input">
        <input type="text" id="user-input" placeholder="Type your message..." />

        <!-- üé§ Mic button (SVG) -->
        <button class="round-btn mic-btn" id="mic-btn">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path
              d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM11 19h2v3h-2v-3z"
            />
          </svg>
        </button>

        <!-- ‚úà Send button -->
        <button class="round-btn send-btn" onclick="sendMessage()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M2 21l21-9L2 3v7l15 2-15 2v7z" />
          </svg>
        </button>
      </div>
    </div>

    <script>
      const chatBox = document.getElementById("chat-box");
      const userInput = document.getElementById("user-input");
      const langSelect = document.getElementById("language");
      const micBtn = document.getElementById("mic-btn");
      const backBtn = document.getElementById("back-btn");

      // Back button functionality
      backBtn.addEventListener("click", () => {
        window.location.href = "index4.html";
      });

      // Backend URL
      const BACKEND_URL = "https://multilingual-ai-assistant.onrender.com/chat";

      // Function to add messages to chat
      function addMessage(text, sender = "bot") {
        const msg = document.createElement("div");
        msg.classList.add(
          "message",
          sender === "user" ? "user-message" : "bot-message"
        );
        msg.innerText = text;
        chatBox.appendChild(msg);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      // Convert PCM to WAV
      function pcmToWav(pcmData, sampleRate) {
        const numChannels = 1;
        const bytesPerSample = 2;
        const buffer = new ArrayBuffer(44 + pcmData.byteLength);
        const view = new DataView(buffer);

        function writeString(view, offset, string) {
          for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
          }
        }

        writeString(view, 0, "RIFF");
        view.setUint32(4, 36 + pcmData.byteLength, true);
        writeString(view, 8, "WAVE");
        writeString(view, 12, "fmt ");
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, numChannels, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, sampleRate * numChannels * bytesPerSample, true);
        view.setUint16(32, numChannels * bytesPerSample, true);
        view.setUint16(34, 8 * bytesPerSample, true);
        writeString(view, 36, "data");
        view.setUint32(40, pcmData.byteLength, true);
        new Int16Array(buffer, 44).set(new Int16Array(pcmData));

        return new Blob([view], { type: "audio/wav" });
      }

      // Send message
      async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;
        addMessage(text, "user");
        userInput.value = "";

        try {
          const response = await fetch(BACKEND_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: text, language: langSelect.value }),
          });

          if (!response.ok) throw new Error("Server responded with an error");

          const data = await response.json();

          addMessage(data.text || "‚ö† No response from server", "bot");

          if (data.audioData) {
            const pcmData = Uint8Array.from(atob(data.audioData), (c) =>
              c.charCodeAt(0)
            ).buffer;
            const wavBlob = pcmToWav(pcmData, 24000);
            const audioUrl = URL.createObjectURL(wavBlob);
            const audio = new Audio(audioUrl);
            audio.play();
          }
        } catch (err) {
          console.error(err);
          addMessage("‚ö† Error connecting to server", "bot");
        }
      }

      // Mic / Voice Recognition
      let recognition;
      if (
        "webkitSpeechRecognition" in window ||
        "SpeechRecognition" in window
      ) {
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;

        micBtn.addEventListener("click", () => {
          if (micBtn.classList.contains("listening")) {
            recognition.stop();
            micBtn.classList.remove("listening");
          } else {
            recognition.lang =
              langSelect.value === "hi"
                ? "hi-IN"
                : langSelect.value === "bn"
                ? "bn-IN"
                : langSelect.value === "pa"
                ? "pa-IN"
                : "en-US";
            recognition.start();
            micBtn.classList.add("listening");
          }
        });

        recognition.onstart = () => {
          micBtn.classList.add("listening");
        };

        recognition.onresult = (event) => {
          const speech = event.results[0][0].transcript;
          userInput.value = speech;
          micBtn.classList.remove("listening");
        };

        recognition.onerror = (event) => {
          console.error("Speech recognition error:", event.error);
          micBtn.classList.remove("listening");
        };

        recognition.onend = () => {
          micBtn.classList.remove("listening");
          if (userInput.value.trim() !== "") sendMessage();
        };
      } else {
        micBtn.style.display = "block";
      }

      // Send on Enter key
      userInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
      });

      // Initial greeting
      addMessage(
        "üëã Welcome to Kisan Mitra! Select your language and start chatting.",
        "bot"
      );
      document.getElementById("back-btn").addEventListener("click", () => {
        window.location.href = "index4.html";
      });
    </script>
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/sw.js")
            .then((reg) => console.log("Service Worker: Registered"))
            .catch((err) => console.log(`Service Worker: Error: ${err}`));
        });
      }
    </script>
  </body>
</html>
