<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="manifest" href="manifest.json" />

    <meta name="theme-color" content="#4CAF50" />

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="Agro Suvidha" />
    <link rel="apple-touch-icon" href="icons/icon-192x192.png" />
    <title>Disease Solution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
      }
      .container {
        max-width: 768px;
        margin: auto;
        padding: 1rem;
      }
      .header {
        background: linear-gradient(
          to bottom right,
          #f87171,
          #ec4899,
          #e11d48
        ); /* ✅ Gradient applied */
        color: white;
        padding: 1rem 0;
        display: flex;
        align-items: center;
        font-size: 1.25rem;
        font-weight: 600;
        padding-left: 1rem;
      }
      .header svg {
        stroke: white;
      }
      .card {
        background-color: #fff;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        padding: 1.5rem;
      }
      /* Buttons still keep the green theme unless you want gradient too */
      .btn-theme {
        background-color: #2a7a3a;
        color: white;
      }
      .btn-theme:hover {
        background-color: #256a34;
      }
    </style>
  </head>
  <body>
    <!-- ✅ Top Bar with Gradient -->
    <div class="header">
      <a href="index4.html" class="mr-2">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 19l-7-7m0 0l7-7m-7 7h18"
          />
        </svg>
      </a>
      <span>Disease Solution</span>
    </div>

    <div class="container mt-4 space-y-6">
      <!-- Upload or Capture Card -->
      <div class="card">
        <h2 class="text-xl font-semibold mb-2">Upload or Capture</h2>
        <p class="text-sm text-gray-500 mb-4">
          Capture or upload a photo of your crop disease for instant analysis.
        </p>
        <div class="flex space-x-4">
          <label
            for="quickCapture"
            class="flex-1 flex items-center justify-center p-3 rounded-md text-white font-medium btn-theme cursor-pointer transition-colors duration-200"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-2"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 3-6 4 8z"
              />
            </svg>
            Quick Capture
          </label>
          <input
            type="file"
            id="quickCapture"
            accept="image/*"
            capture="camera"
            class="hidden"
          />
          <label
            for="imageUpload"
            class="flex-1 flex items-center justify-center p-3 rounded-md text-white font-medium btn-theme cursor-pointer transition-colors duration-200"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-2"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414L9 2.586V11a1 1 0 11-2 0V4.586L4.707 7.707a1 1 0 01-1.414-1.414L8 1.172a1 1 0 011.414 0l4.707 4.707a1 1 0 01-1.414 1.414L10 4.414V11a1 1 0 11-2 0V4.414L6.293 6.707a1 1 0 010-1.414z"
                clip-rule="evenodd"
              />
            </svg>
            Upload Image
          </label>
          <input type="file" id="imageUpload" accept="image/*" class="hidden" />
        </div>

        <!-- Preview Section -->
        <div id="imagePreviewContainer" class="mt-4 hidden">
          <p class="text-sm text-gray-600 mb-2">Selected Image:</p>
          <img
            id="imagePreview"
            src=""
            alt="Preview"
            class="rounded-md border border-gray-300 shadow-sm max-w-[200px]"
          />
        </div>
      </div>

      <!-- Details Card -->
      <div class="card">
        <h2 class="text-xl font-semibold mb-4">
          Provide More Details (Optional)
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label
              for="cropType"
              class="block text-sm font-medium text-gray-700"
              >Crop Type (optional)</label
            >
            <input
              type="text"
              id="cropType"
              placeholder="e.g. Wheat, Rice, Tomato"
              class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
            />
          </div>
          <div>
            <label
              for="growthStage"
              class="block text-sm font-medium text-gray-700"
              >Growth Stage (optional)</label
            >
            <select
              id="growthStage"
              class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
            >
              <option value="">-- Select stage --</option>
            </select>
          </div>
        </div>

        <div class="mb-4">
          <label for="symptoms" class="block text-sm font-medium text-gray-700"
            >Symptoms Observed (optional)</label
          >
          <textarea
            id="symptoms"
            rows="3"
            placeholder="Describe any visible issues..."
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
          ></textarea>
        </div>

        <div class="mb-4">
          <label for="notes" class="block text-sm font-medium text-gray-700"
            >Additional Notes (optional)</label
          >
          <textarea
            id="notes"
            rows="3"
            placeholder="Other observations..."
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
          ></textarea>
        </div>

        <div class="mb-6">
          <label for="language" class="block text-sm font-medium text-gray-700"
            >Select Language</label
          >
          <select
            id="language"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
          >
            <option value="en">English</option>
            <option value="hi">हिन्दी</option>
            <option value="bn">বাংলা</option>
            <option value="pa">ਪੰਜਾਬੀ</option>
          </select>
        </div>

        <div class="text-center">
          <button
            id="submitBtn"
            class="inline-flex items-center justify-center w-full py-3 px-6 rounded-md font-bold text-lg btn-theme transition-colors duration-200"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 mr-3"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path d="M12 2L3 22l9-2 9 2z" />
            </svg>
            Submit for Analysis
          </button>
        </div>

        <div id="result" class="mt-4 p-4 rounded-md hidden"></div>
        <audio id="audioPlayer" controls class="mt-4 hidden"></audio>
      </div>
    </div>

    <script>
      const backendBaseURL = "https://pest-disease-backend.onrender.com";

      const quickCaptureInput = document.getElementById("quickCapture");
      const imageUploadInput = document.getElementById("imageUpload");
      const cropTypeInput = document.getElementById("cropType");
      const growthStageSelect = document.getElementById("growthStage");
      const symptomsTextarea = document.getElementById("symptoms");
      const notesTextarea = document.getElementById("notes");
      const languageSelect = document.getElementById("language");
      const submitBtn = document.getElementById("submitBtn");
      const resultDiv = document.getElementById("result");
      const audioPlayer = document.getElementById("audioPlayer");
      const imagePreview = document.getElementById("imagePreview");
      const imagePreviewContainer = document.getElementById(
        "imagePreviewContainer"
      );

      let selectedFile = null;

      quickCaptureInput.addEventListener("change", handleFileChange);
      imageUploadInput.addEventListener("change", handleFileChange);

      function handleFileChange(event) {
        selectedFile = event.target.files[0];
        if (selectedFile) {
          console.log("File selected:", selectedFile.name);
          imagePreview.src = URL.createObjectURL(selectedFile);
          imagePreviewContainer.classList.remove("hidden");
        }
      }

      submitBtn.addEventListener("click", async () => {
        if (!selectedFile) {
          alert("Please upload or capture an image.");
          return;
        }

        resultDiv.innerHTML = "Processing...";
        resultDiv.classList.remove("hidden");
        audioPlayer.classList.add("hidden");
        audioPlayer.src = "";

        const formData = new FormData();
        formData.append("image", selectedFile);
        formData.append("language", languageSelect.value);
        formData.append("crop_type", cropTypeInput.value.trim());
        formData.append("growth_stage", growthStageSelect.value);
        formData.append("symptoms", symptomsTextarea.value.trim());
        formData.append("notes", notesTextarea.value.trim());

        try {
          const response = await fetch(`${backendBaseURL}/predict/`, {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Error ${response.status}: ${errorText}`);
          }

          const data = await response.json();

          let html = `
                    <div class="font-bold text-lg mb-2 text-green-700">Analysis Result</div>
                    <p><b>Predicted Disease:</b> ${data.predicted_class}</p>
                    <p><b>Advice:</b> ${data.recommendation.advice || "N/A"}</p>
                `;

          if (
            data.recommendation.pesticides &&
            data.recommendation.pesticides.length
          ) {
            html += `<p><b>Pesticides:</b> ${data.recommendation.pesticides.join(
              ", "
            )}</p>`;
          }
          if (
            data.recommendation.fertilizers &&
            data.recommendation.fertilizers.length
          ) {
            html += `<p><b>Fertilizers:</b> ${data.recommendation.fertilizers.join(
              ", "
            )}</p>`;
          }
          if (data.recommendation.dosage) {
            html += `<p><b>Dosage:</b> ${data.recommendation.dosage}</p>`;
          }

          resultDiv.innerHTML = html;
          resultDiv.classList.remove("hidden");

          if (data.tts_audio_url) {
            audioPlayer.src = `${backendBaseURL}${data.tts_audio_url}`;
            audioPlayer.classList.remove("hidden");
            audioPlayer.play();
          }
        } catch (error) {
          resultDiv.innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;
        }
      });
    </script>
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/sw.js")
            .then((reg) => console.log("Service Worker: Registered"))
            .catch((err) => console.log(`Service Worker: Error: ${err}`));
        });
      }
    </script>
  </body>
</html>
